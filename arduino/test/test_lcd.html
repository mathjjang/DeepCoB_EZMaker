<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EZMaker LCD(I2C) 테스트 (Arduino)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 560px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    button { padding: 8px 12px; margin: 4px 4px 4px 0; }
    input, select { padding: 6px 8px; margin: 2px 0; }
    .row { margin-bottom: 8px; }
    #log { margin-top: 12px; padding: 8px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; white-space: pre-wrap; height: 180px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>I2C LCD 테스트</h1>

  <div class="row">
    <button id="connectBtn">블루투스 연결</button>
  </div>

  <div class="row">
    LCD 타입:
    <select id="typeSelect">
      <option value="16X2" selected>16x2</option>
      <option value="20X4">20x4</option>
    </select>
  </div>

  <div class="row">
    SCL(GPIO): <input id="sclInput" type="number" value="40" style="width:80px;">
    SDA(GPIO): <input id="sdaInput" type="number" value="41" style="width:80px;">
    <button id="initBtn" disabled>초기화</button>
  </div>

  <div class="row">
    <button id="clearBtn" disabled>화면 지우기</button>
    <button id="blOnBtn" disabled>백라이트 ON</button>
    <button id="blOffBtn" disabled>백라이트 OFF</button>
  </div>

  <div class="row">
    row: <input id="rowInput" type="number" value="0" style="width:60px;">
    col: <input id="colInput" type="number" value="0" style="width:60px;">
  </div>

  <div class="row">
    text: <input id="textInput" type="text" value="EZMaker LCD Test" style="width:280px;">
    <button id="printBtn" disabled>출력</button>
  </div>

  <div id="log"></div>

  <script src="./integratedBleLib_Camera.js"></script>
  <script>
    const connectBtn = document.getElementById('connectBtn');
    const typeSelect = document.getElementById('typeSelect');
    const sclInput   = document.getElementById('sclInput');
    const sdaInput   = document.getElementById('sdaInput');
    const initBtn    = document.getElementById('initBtn');
    const clearBtn   = document.getElementById('clearBtn');
    const blOnBtn    = document.getElementById('blOnBtn');
    const blOffBtn   = document.getElementById('blOffBtn');
    const rowInput   = document.getElementById('rowInput');
    const colInput   = document.getElementById('colInput');
    const textInput  = document.getElementById('textInput');
    const printBtn   = document.getElementById('printBtn');
    const logArea    = document.getElementById('log');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logArea.textContent += `[${time}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    let bleManager = null;
    let lcd = null;

    window.addEventListener('load', () => {
      if (typeof BLEManager === 'undefined' || typeof LcdDisplay === 'undefined') {
        log('BLE/LCD 라이브러리 로드 실패. 페이지를 새로고침 해보세요.');
        return;
      }
      bleManager = BLEManager.getInstance();
      lcd = new LcdDisplay();

      // 기본값: 라이브러리 상수(EZ_I2C_*)가 있으면 그 값으로 자동 세팅
      if (typeof EZ_I2C_SCL_PIN === 'number') sclInput.value = String(EZ_I2C_SCL_PIN);
      if (typeof EZ_I2C_SDA_PIN === 'number') sdaInput.value = String(EZ_I2C_SDA_PIN);

      connectBtn.addEventListener('click', handleConnect);
      initBtn.addEventListener('click', handleInit);
      clearBtn.addEventListener('click', async () => { try { await lcd.clear(); log('LCD:CLEAR'); } catch (e) { log('CLEAR 실패: ' + e.message); }});
      blOnBtn.addEventListener('click', async () => { try { await lcd.setBacklight(true); log('LCD:BACKLIGHT:ON'); } catch (e) { log('BL ON 실패: ' + e.message); }});
      blOffBtn.addEventListener('click', async () => { try { await lcd.setBacklight(false); log('LCD:BACKLIGHT:OFF'); } catch (e) { log('BL OFF 실패: ' + e.message); }});
      printBtn.addEventListener('click', handlePrint);
    });

    async function handleConnect() {
      if (!navigator.bluetooth) { log('이 브라우저는 Web Bluetooth API를 지원하지 않습니다.'); return; }
      connectBtn.disabled = true;
      initBtn.disabled = true;
      log('블루투스 장치 선택 중...');
      try {
        await bleManager.connect();
        log('블루투스 연결 완료');
        initBtn.disabled = false;
      } catch (e) {
        log('연결 실패: ' + e.message);
        connectBtn.disabled = false;
      }
    }

    async function handleInit() {
      const type = (typeSelect.value || '16X2').toUpperCase();
      const scl = parseInt(sclInput.value, 10);
      const sda = parseInt(sdaInput.value, 10);
      if (isNaN(scl) || isNaN(sda)) { log('SCL/SDA 핀 번호를 올바르게 입력하세요.'); return; }
      initBtn.disabled = true;
      try {
        // 블록코드 규칙: lcd.init(type, scl, sda) (LCD:INIT은 SCL,SDA 순서)
        log(`LCD 초기화: ${type} (SCL=${scl}, SDA=${sda})`);
        await lcd.init(type, scl, sda);
        log('LCD:INIT 전송 완료');
        clearBtn.disabled = false;
        blOnBtn.disabled = false;
        blOffBtn.disabled = false;
        printBtn.disabled = false;
      } catch (e) {
        log('LCD 초기화 실패: ' + e.message);
      } finally {
        initBtn.disabled = false;
      }
    }

    async function handlePrint() {
      let row = parseInt(rowInput.value, 10);
      let col = parseInt(colInput.value, 10);
      if (isNaN(row)) row = 0;
      if (isNaN(col)) col = 0;
      const txt = textInput.value || '';
      try {
        await lcd.print(row, col, txt);
        log(`LCD:PRINT (${row},${col}) "${txt}"`);
      } catch (e) {
        log('PRINT 실패: ' + e.message);
      }
    }
  </script>
</body>
</html>

