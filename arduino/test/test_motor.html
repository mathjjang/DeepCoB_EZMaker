<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DC 모터 테스트 (Arduino)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 520px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    button { padding: 8px 12px; margin: 4px 4px 4px 0; }
    input { padding: 6px 8px; margin: 2px 0; width: 90px; }
    #log { margin-top: 12px; padding: 8px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; white-space: pre-wrap; height: 160px; overflow-y: auto; }
    .row { margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>DC 모터 테스트</h1>

  <button id="connectBtn">블루투스 연결</button>

  <div class="row">
    모터 핀(GPIO):
    <input id="pinInput" type="number" value="39">
    <button id="setPinBtn" disabled>핀 설정</button>
  </div>

  <div class="row">
    <button id="stopBtn" disabled>정지</button>
    <button id="spd30Btn" disabled>속도 30%</button>
    <button id="spd50Btn" disabled>속도 50%</button>
    <button id="spd100Btn" disabled>속도 100%</button>
  </div>

  <div id="log"></div>

  <script src="./integratedBleLib_Camera.js"></script>
  <script>
    const connectBtn = document.getElementById('connectBtn');
    const pinInput = document.getElementById('pinInput');
    const setPinBtn = document.getElementById('setPinBtn');
    const stopBtn = document.getElementById('stopBtn');
    const spd30Btn = document.getElementById('spd30Btn');
    const spd50Btn = document.getElementById('spd50Btn');
    const spd100Btn = document.getElementById('spd100Btn');
    const logArea = document.getElementById('log');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logArea.textContent += `[${time}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    let bleManager = null;
    let motor = null;

    window.addEventListener('load', () => {
      if (typeof BLEManager === 'undefined' || typeof DCMotor === 'undefined') {
        log('BLE/DCMotor 라이브러리 로드 실패. 페이지를 새로고침 해보세요.');
        return;
      }
      bleManager = BLEManager.getInstance();
      motor = new DCMotor();

      connectBtn.addEventListener('click', handleConnect);
      setPinBtn.addEventListener('click', handleSetPin);
      stopBtn.addEventListener('click', () => handleSpeed('stop', 0));
      spd30Btn.addEventListener('click', () => handleSpeed('speed', 30));
      spd50Btn.addEventListener('click', () => handleSpeed('speed', 50));
      spd100Btn.addEventListener('click', () => handleSpeed('speed', 100));
    });

    function setControlsEnabled(enabled) {
      setPinBtn.disabled = !enabled;
      stopBtn.disabled = !enabled;
      spd30Btn.disabled = !enabled;
      spd50Btn.disabled = !enabled;
      spd100Btn.disabled = !enabled;
    }

    async function handleConnect() {
      if (!navigator.bluetooth) { log('이 브라우저는 Web Bluetooth API를 지원하지 않습니다.'); return; }
      connectBtn.disabled = true;
      setControlsEnabled(false);
      log('블루투스 장치 선택 중...');
      try {
        await bleManager.connect();
        log('블루투스 연결 완료');
        setPinBtn.disabled = false;
      } catch (e) {
        log('연결 실패: ' + e.message);
        connectBtn.disabled = false;
      }
    }

    async function handleSetPin() {
      const pin = parseInt(pinInput.value, 10);
      if (isNaN(pin) || pin < 0) { log('핀 번호를 올바르게 입력하세요.'); return; }
      setControlsEnabled(false);
      try {
        log(`MOTOR:PIN:${pin} 전송`);
        await motor.setPin(pin);
        log('DC 모터 핀 설정 완료');
        setControlsEnabled(true);
      } catch (e) {
        log('DC 모터 핀 설정 실패: ' + e.message);
        setPinBtn.disabled = false;
      }
    }

    async function handleSpeed(mode, speed) {
      try {
        if (mode === 'stop') {
          await motor.stop();
          log('MOTOR:STOP 전송');
        } else {
          await motor.setSpeed(speed);
          log(`MOTOR:SPEED:${speed} 전송`);
        }
      } catch (e) {
        log('모터 제어 실패: ' + e.message);
      }
    }
  </script>
</body>
</html>

