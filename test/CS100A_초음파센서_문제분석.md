# CS100A 초음파 센서 (1핀 방식) 문제 분석 및 해결 방안

## 📋 문제 요약

기존 초음파 센서 테스트 코드들이 제대로 동작하지 않는 문제

## 🔍 원인 분석

### 1. **Trig 신호 후 대기 시간 부족**
- **문제**: Trig 신호 직후 바로 Echo 측정 시작
- **원인**: CS100A 등 일부 1핀 센서는 Trig 인식 후 Echo 준비에 **약 450μs** 필요
- **기존 코드**: Trig 직후 즉시 핀 모드 전환 및 측정
- **개선**: Trig LOW 복귀 후 **2~10μs 추가 대기**

### 2. **핀 모드 전환 안정화 시간 부족**
- **문제**: OUT → IN 전환 직후 바로 `time_pulse_us()` 호출
- **원인**: GPIO 모드 전환에 물리적 시간 필요 (특히 PULL_DOWN 설정 시)
- **기존 코드**: 전환 직후 바로 측정
- **개선**: 모드 전환 후 **10μs 안정화 대기**

### 3. **센서 초기화 LOW 시간 부족**
- **문제**: LOW 상태 유지가 2μs로 너무 짧음
- **원인**: 일부 센서는 최소 5μs 이상의 LOW 필요
- **기존 코드**: `time.sleep_us(2)`
- **개선**: `time.sleep_us(5)` 이상

### 4. **연속 측정 간격 부족**
- **문제**: 측정 간격이 0.5초(500ms)로 충분하지만, 센서 리셋 부족
- **원인**: 센서 내부 회로가 다음 측정을 준비하는데 시간 필요
- **권장**: 최소 **60ms 간격**, 안정성을 위해 **100ms 이상** 권장

### 5. **PULL_DOWN 저항 누락 (일부 코드)**
- **문제**: 입력 모드 전환 시 플로팅 상태 발생 가능
- **원인**: Echo 신호 대기 중 핀이 부정 상태일 수 있음
- **개선**: `Pin.IN, Pin.PULL_DOWN` 명시적 설정

## ✅ 개선 사항

### 새로운 라이브러리: `lib/ultrasonic_1pin.py`

#### 주요 개선점:

1. **타이밍 최적화**
```python
# LOW 안정화: 2us → 5us
time.sleep_us(5)

# Trig 후 대기: 0us → 2us
time.sleep_us(2)

# 핀 모드 전환 후 안정화: 0us → 10us
time.sleep_us(10)
```

2. **명시적 PULL_DOWN 설정**
```python
self.pin = Pin(self.pin_num, Pin.IN, Pin.PULL_DOWN)
```

3. **센서 초기화 개선**
```python
# 초기화 시 50ms 안정화 대기
self.pin.value(0)
time.sleep_ms(50)
```

4. **에러 핸들링 강화**
- 범위 체크 (2cm ~ 400cm)
- 타임아웃 처리
- 센서 리셋 기능

5. **평균값 측정 모드 추가**
```python
sensor.get_distance_average(samples=3)  # 노이즈 감소
```

## 🔧 사용 방법

### 기본 사용:
```python
from lib.ultrasonic_1pin import Ultrasonic1Pin

sensor = Ultrasonic1Pin(pin=48)
distance = sensor.get_distance()
if distance:
    print(f"Distance: {distance:.1f} cm")
```

### 평균값 측정:
```python
distance = sensor.get_distance_average(samples=3)
```

### 센서 리셋:
```python
sensor.reset()  # 연속 실패 시 사용
```

## 📌 CS100A 특성 (추정)

1. **1핀 방식**: Trig/Echo 통합
2. **Trig 펄스**: 10μs HIGH
3. **Echo 준비 시간**: 약 450μs
4. **측정 범위**: 2cm ~ 400cm
5. **측정 주기**: 최소 60ms

## 🧪 테스트 방법

```bash
# 새로운 테스트 파일 실행
python test_ultrasonic_cs100a_ezmaker.py
```

## 📝 참고 사항

- GPIO 48 (D2) 사용 권장
- 다른 GPIO 테스트: GPIO 2 (A0/D7), GPIO 21 (D0) 등
- 측정 실패가 연속 5회 이상 시 `sensor.reset()` 자동 호출
- 노이즈가 심한 환경: `get_distance_average()` 사용 권장

## 🔄 기존 코드와의 차이점

| 항목 | 기존 코드 | 개선 코드 |
|------|----------|----------|
| LOW 대기 | 2μs | 5μs |
| Trig 후 대기 | 0μs | 2μs |
| 모드 전환 후 대기 | 0μs | 10μs |
| PULL_DOWN | 미설정 (일부) | 명시적 설정 |
| 초기화 대기 | 0ms | 50ms |
| 평균값 측정 | 없음 | 지원 |
| 리셋 기능 | 수동 | 자동/수동 |

