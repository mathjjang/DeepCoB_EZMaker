<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE 블록코딩 테스트</title>
    <!-- integratedBleLib.js 참조 -->
    <script src="integratedBleLib_Camera.js"></script>
    <style>
        #lightLabel {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button id="bleConnectBtn">연결</button>
    <label id="bleName">BLE 이름: </label><input type="text" id="bleNameInput" style="width: 100px;" value=""><button id="serialConnectBtn">시리얼
        연결</button>
    </br>
    <div id="serialStatus" style="color: gray; margin-top: 5px;">시리얼 연결 상태: 연결되지 않음</div>
    </br>
    <div>
        <textarea id="serialOutput" style="width: 100%; height: 100px; border: 1px solid #ccc; padding: 5px;" readonly></textarea>
    </div>
    </br>
    <div>타이머를 통해 센서측정을 연속적으로 하려면 실행 버튼을 눌러주세요</div>
    <div><button id="sensorOnBtn">실행</button>
        <button id="sensorOffBtn">종료</button>
    </div>
    
    <div>조도센서 값: <label id="lightLabel">측정 전</label></div>
    <div>초음파센서 값: <label id="ultraLabel">측정 전</label></div>
    <div>온도: <label id="tempLabel">측정 전</label></div>
    <div>습도: <label id="humidLabel">측정 전</label></div>
    <div>먼지 농도: <label id="dustLabel">측정 전</label></div>
    <div>자이로센서 값: <label id="gyroLabel">측정 전</label></div>
    <div>심박수: <label id="heartLabel">측정 전</label> BPM</div>
    <div>토양수분: <label id="soilLabel">측정 전</label></div>
    <div>빗방울센서: <label id="rainLabel">측정 전</label></div>
    </br>
    <div>센서 측정을 1회 실행하려면 실행 버튼을 눌러주세요</div>
    조도센서 테스트: <button id="LightSensorOnBtn">실행</button></br>
    초음파센서 테스트: <button id="UltraOnBtn">실행</button></br>
    온습도센서 테스트: <button id="DHTOnBtn">실행</button> </br>
    먼지센서 테스트: <button id="DustOnBtn">실행</button> </br>
    자이로센서 테스트: <button id="GyroOnBtn">실행</button></br>
    <button id="GyroStreamOnBtn">스트림실행</button><button id="GyroStreamStopBtn">스트림중지</button></br>
    심장박동수 테스트: <button id="HeartOnBtn">실행</button></br>
    <button id="HeartStreamOnBtn">스트림실행</button><button id="HeartStreamStopBtn">스트림중지</button></br>
    토양수분센서 테스트: <button id="SoilOnBtn">실행</button></br>
    토양수분센서 보정: <button id="SoilCalibrateDryBtn">건조 보정</button><button id="SoilCalibrateWetBtn">습윤 보정</button></br>
    빗방울센서 테스트: <button id="RainOnBtn">실행</button></br>

    </br>
    <div>액츄에이터 실행</div>
    <div>LED:<button id="ledOnBtn">켜기</button>
    <button id="ledOffBtn">끄기</button>
    </br>
    <input type="text" id="blinkInterval" style="width: 50px;" min="0"  value="1000">
    <button id="ledBlinkBtn">깜빡이기</button>
    <button id="ledBlinkStopBtn">깜빡임 중지</button></div>
    <input type="text" id="ledBrightness" style="width: 50px;" min="0" max="100" value="50">
    <button id="ledBrightnessBtn">밝기 설정</button>
    </br>
    <div>DC 모터 실행</div>
    <div>
        <input type="text" id="dcMotorSpeed" style="width: 50px;" min="0" max="100" value="50">
        <button id="dcMotorSetSpeedBtn">속도 설정</button>
        <button id="dcMotorStopBtn">정지</button>
    </div>
    <!-- 버저 섹션 추가 -->
    <div>
        버저:
        <button id="buzzerInitBtn">초기화</button>
        <button id="buzzerBeepOnBtn">시작</button>
        <button id="buzzerStopBtn">중지</button>

        </br>
        <div style="margin-top: 5px;">
            <span>비프음 설정:</span>
        </br>
            횟수:
            <input type="number" id="beepCount" style="width: 40px;" min="1" max="10" value="3" placeholder="횟수">
            주파수(Hz):
            <input type="number" id="beepFreq" style="width: 60px;" min="100" max="5000" value="2000" placeholder="주파수(Hz)"> 
            길이(ms):
            <input type="number" id="beepDuration" style="width: 60px;" min="50" max="1000" value="100" placeholder="길이(ms)">
            간격(ms):
            <input type="number" id="beepInterval" style="width: 60px;" min="50" max="1000" value="100" placeholder="간격(ms)">
            <button id="buzzerBeepBtn">비프음</button>
        </div>
        <div style="margin-top: 5px;">
            <span>멜로디:</span>
            <select id="melodySelect" style="width: 100px;">
                <option value="TWINKLE">반짝반짝 작은별</option>
                <option value="FUR_ELISE">엘리제를 위하여</option>
                <option value="SCHOOL_BELL">학교종이 땡땡땡</option>
                <option value="SUCCESS">성공 효과음</option>
                <option value="ERROR">오류 효과음</option>
                <option value="ALERT">경고음</option>
            </select>
            <input type="number" id="melodyTempo" style="width: 60px;" min="60" max="500" value="500" placeholder="템포">
            <button id="buzzerMelodyBtn">멜로디</button>
        </div>
    </div>
    </br>
    <div>
        NeoPixel:
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 60px;">LED 1:</span>
            <input type="text" id="color1" style="width: 80px; margin-right: 5px;" value="255,0,0">
            <input type="color" id="colorPicker1" style="width: 40px; height: 30px;">
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 60px;">LED 2:</span>
            <input type="text" id="color2" style="width: 80px; margin-right: 5px;" value="0,255,0">
            <input type="color" id="colorPicker2" style="width: 40px; height: 30px;">
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 60px;">LED 3:</span>
            <input type="text" id="color3" style="width: 80px; margin-right: 5px;" value="0,0,255">
            <input type="color" id="colorPicker3" style="width: 40px; height: 30px;">
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 60px;">LED 4:</span>
            <input type="text" id="color4" style="width: 80px; margin-right: 5px;" value="255,255,255">
            <input type="color" id="colorPicker4" style="width: 40px; height: 30px;">
        </div>
        <div>
            <input type="text" id="brightness" style="width: 50px;" min="0" max="100" value="50">
            <button id="neopixelBrightnessBtn">밝기 설정</button>
        </div>
        <button id="neopixelOnBtn">켜기</button>
        <button id="neopixelOffBtn">끄기</button>
        <button id="rainbowBtn" style="margin-left: 5px;">무지개 효과</button>
    </div>
    
    </br>
    <div>
        서보모터: <input type="range" id="servoSlider" style="width: 150px;" min="0" max="180" value="90">
        <button id="servoBtn">각도 설정</button>
        <span id="servoAngleLabel">90°</span>
    </div>
    </br>
    <!-- 카메라 영역 추가 -->
    <div id="cameraContainer" style="margin-top: 20px;">
        <h3>카메라</h3>
        <div>
            <img id="cameraView" width="320" height="240" style="border: 1px solid #ccc; background-color: #f0f0f0;" alt="카메라 뷰">
        </div>
        <div style="margin-top: 10px;">
            <input type="text" id="streamInterval" min="100" max="1000" value="200" style="width: 50px;">
            <button id="streamBtn">스트리밍 시작</button>
            <button id="stopBtn">스트리밍 중지</button>
            <button id="snapBtn">사진 촬영</button>
        </div>
    </div>
    
    <script>
        // UI 요소 참조
        const connectBtn = document.getElementById('bleConnectBtn');
        const serialConnectBtn = document.getElementById('serialConnectBtn');
        const serialStatus = document.getElementById('serialStatus');
        const serialOutput = document.getElementById('serialOutput');
        const lightLabel = document.getElementById('lightLabel');
        const ultraLabel = document.getElementById('ultraLabel');
        const tempLabel = document.getElementById('tempLabel');
        const humidLabel = document.getElementById('humidLabel');
        const dustLabel = document.getElementById('dustLabel');
        const gyroLabel = document.getElementById('gyroLabel');
        const heartLabel = document.getElementById('heartLabel');
        const soilLabel = document.getElementById('soilLabel');
        const rainLabel = document.getElementById('rainLabel');
        const ledOnBtn = document.getElementById('ledOnBtn');
        const ledOffBtn = document.getElementById('ledOffBtn');
        const servoBtn = document.getElementById('servoBtn');
        const sensorOnBtn = document.getElementById('sensorOnBtn');
        const sensorOffBtn = document.getElementById('sensorOffBtn');
        const LightSensorOnBtn = document.getElementById('LightSensorOnBtn');
        const UltraOnBtn = document.getElementById('UltraOnBtn');
        const DHTOnBtn = document.getElementById('DHTOnBtn');
        const DustOnBtn = document.getElementById('DustOnBtn');
        const HeartOnBtn = document.getElementById('HeartOnBtn');
        const HeartStreamOnBtn = document.getElementById('HeartStreamOnBtn');
        const HeartStreamStopBtn = document.getElementById('HeartStreamStopBtn');
        const SoilOnBtn = document.getElementById('SoilOnBtn');
        const SoilCalibrateDryBtn = document.getElementById('SoilCalibrateDryBtn');
        const SoilCalibrateWetBtn = document.getElementById('SoilCalibrateWetBtn');
        const RainOnBtn = document.getElementById('RainOnBtn');
        
        // 카메라 UI 요소 참조 추가
        const cameraView = document.getElementById('cameraView');
        const streamBtn = document.getElementById('streamBtn');
        const stopBtn = document.getElementById('stopBtn');
        const snapBtn = document.getElementById('snapBtn');
        
        // BLE 매니저 인스턴스 가져오기
        const bleManager = BLEManager.getInstance();
        
        // 시리얼 매니저 인스턴스 가져오기
        const serialManager = SerialManager.getInstance();
        
        let lightSensor = null;
        let ultraSensor = null; // 초음파센서 인스턴스
        let dhtSensor = null;   // 온습도센서 인스턴스
        let led = null; // LED 센서 인스턴스
        let servo = null; // 서보모터 인스턴스 추가
        let camera = null; // 카메라 인스턴스 추가
        let dustSensor = null; // 먼지 센서 인스턴스 추가
        let neoPixel = null; // 네오픽셀 인스턴스 추가
        let buzzer = null; // 버저 인스턴스 추가
        let sensorDataTimer = null;
        let dcMotor = null; // DC 모터 인스턴스 추가
        let gyroSensor = null; // 자이로센서 인스턴스 추가
        let heartSensor = null; // 심장박동 센서 인스턴스 추가
        let soilSensor = null; // 토양수분센서 인스턴스 추가
        let rainSensor = null; // 빗방울센서 인스턴스 추가
        
        // BLE 명령어 자동 재시도 함수
        async function executeWithRetry(fn, maxRetries = 2) {
            let retries = 0;
            
            while (retries <= maxRetries) {
                try {
                    return await fn();
                } catch (error) {
                    // GATT 작업 충돌 오류인 경우에만 재시도
                    if (error.message && error.message.includes("GATT operation already in progress")) {
                        retries++;
                        if (retries <= maxRetries) {
                            console.log(`GATT 작업 충돌 감지, ${retries}/${maxRetries} 재시도 중...`);
                            // 300-500ms 무작위 지연 적용
                            const delay = 300 + Math.random() * 200;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            // 루프 계속 (재시도)
                        } else {
                            console.error("최대 재시도 횟수 초과:", error);
                            throw error;
                        }
                    } else {
                        // 다른 종류의 오류는 바로 전파
                        throw error;
                    }
                }
            }
        }
        
        // LED 초기화 함수
        function initLED() {
            // 이미 초기화되어 있으면 무시
            if (led) return;
            
            console.log("LED 초기화 시작");
            
            // LED 인스턴스 생성
            led = new LED();
            
            // LED 핀 설정 (핀 2 사용)
            led.setPin(39).then(() => {
                console.log("LED 핀 설정 완료");
                // 초기 상태로 LED 끄기
                return led.turnOff();
            }).then(() => {
                console.log("LED 초기 상태(OFF) 설정 완료");
            }).catch(err => {
                console.error("LED 초기화 실패:", err);
            });
            
            console.log("LED 초기화 완료");
        }
        
        // 초음파센서 초기화 함수
        function initUltrasonicSensor(trigPin, echoPin) {
            // 이미 초기화되어 있으면 무시
            if (ultraSensor) return;
            
            console.log("초음파센서 초기화 시작");
            
            // 초음파센서 인스턴스 생성
            ultraSensor = new UltrasonicSensor();
            
            // 초음파센서 핀 설정 (트리거 핀과 에코 핀 설정)
            ultraSensor.setPin(trigPin, echoPin).then(() => {
                console.log("초음파센서 핀 설정 완료");
                // 초기 상태 요청
                return ultraSensor.getStatus();
            }).catch(err => {
                console.error("초음파센서 초기화 실패:", err);
            });
            
            console.log("초음파센서 초기화 완료");
        }
        
        // 온습도센서 초기화 함수
        function initDHTSensor(pin) {
            // 이미 초기화되어 있으면 무시
            if (dhtSensor) return;
            
            console.log("온습도센서 초기화 시작");
            
            // 온습도센서 인스턴스 생성
            dhtSensor = new DHTSensor();
            
            // 온습도센서 핀 설정
            dhtSensor.setPin(pin).then(() => {
                console.log("온습도센서 핀 설정 완료");
                // 초기 상태 요청
                return dhtSensor.getStatus();
            }).catch(err => {
                console.error("온습도센서 초기화 실패:", err);
            });
            
            console.log("온습도센서 초기화 완료");
        }
        
        // 조도센서 초기화 함수
        function initLightSensor(pinNum) {
            // 이미 초기화되어 있으면 무시
            if (lightSensor) return;
            
            console.log("조도센서 초기화 시작");
            
            // 조도센서 인스턴스 생성
            lightSensor = new LightSensor();
            
            // 조도센서 핀 설정 (아날로그 핀 1 사용)
            lightSensor.setPin(pinNum).then(() => {
                console.log("조도센서 핀 설정 완료");
            }).catch(err => {
                console.error("조도센서 핀 설정 실패:", err);
            });
            
            

            
            
            console.log("조도센서 초기화 완료");
        }
        
        // 토양수분센서 초기화 함수
        function initSoilSensor(pinNum) {
            // 이미 초기화되어 있으면 무시
            if (soilSensor) return;
            
            console.log("토양수분센서 초기화 시작");
            
            // 토양수분센서 인스턴스 생성
            soilSensor = new SoilMoistureSensor();
            
            // 토양수분센서 핀 설정 (아날로그 핀 사용)
            soilSensor.setPin(pinNum).then(() => {
                console.log("토양수분센서 핀 설정 완료");
            }).catch(err => {
                console.error("토양수분센서 핀 설정 실패:", err);
            });
            
            console.log("토양수분센서 초기화 완료");
        }
        
        // 빗방울센서 초기화 함수
        function initRainSensor(pinNum) {
            // 이미 초기화되어 있으면 무시
            if (rainSensor) {
                console.log("빗방울센서 이미 초기화됨");
                return;
            }
            
            console.log(`빗방울센서 초기화 시작 - 핀: ${pinNum}`);
            
            // 빗방울센서 인스턴스 생성
            rainSensor = new RainSensor();
            console.log("빗방울센서 인스턴스 생성 완료:", rainSensor);
            
            // 빗방울센서 핀 설정 (아날로그 핀 사용)
            rainSensor.setPin(pinNum).then(() => {
                console.log(`빗방울센서 핀 ${pinNum} 설정 완료`);
            }).catch(err => {
                console.error(`빗방울센서 핀 ${pinNum} 설정 실패:`, err);
            });
            
            console.log("빗방울센서 초기화 완료");
        }
        
        // 먼지 센서 초기화 함수
        function initDustSensor(ledPin, adcPin) {
            // 이미 초기화되어 있으면 무시
            if (dustSensor) return;
            
            console.log("먼지 센서 초기화 시작");
            
            // 먼지 센서 인스턴스 생성
            dustSensor = new DustSensor();
            
            // 먼지 센서 핀 설정
            dustSensor.setPin(ledPin, adcPin).then(() => {
                console.log("먼지 센서 핀 설정 완료");
                // 초기 상태 요청
                //return dustSensor.getStatus();
            }).catch(err => {
                console.error("먼지 센서 초기화 실패:", err);
            });
            
            console.log("먼지 센서 초기화 완료");
        }
        
        // 심장박동 센서 초기화 함수
        function initHeartRateSensor(sdaPin, sclPin) {
            // 이미 초기화되어 있으면 무시
            if (heartSensor) return;
            
            console.log("심장박동 센서 초기화 시작");
            
            // 심장박동 센서 인스턴스 생성
            heartSensor = new HeartRateSensor();
            
            // 심장박동 센서 핀 설정 (I2C 인터페이스를 위한 SDA, SCL 핀)
            heartSensor.setPin(sdaPin, sclPin).then(() => {
                console.log("심장박동 센서 핀 설정 완료");
                // 초기 상태 요청
                //return heartSensor.getStatus();
            }).catch(err => {
                console.error("심장박동 센서 초기화 실패:", err);
            });
            
            console.log("심장박동 센서 초기화 완료");
        }

        // 서보모터 초기화 함수
        function initServo(pin) {
            // 이미 초기화되어 있으면 무시
            if (servo) return;
            
            console.log("서보모터 초기화 시작");
            
            // 서보모터 인스턴스 생성
            servo = new ServoMotor();
            
            // 서보모터 핀 설정
            servo.setPin(pin).then(() => {
                console.log("서보모터 핀 설정 완료");
            }).catch(err => {
                console.error("서보모터 핀 설정 실패:", err);
            });
            
            console.log("서보모터 초기화 완료");
        }
        
        // 카메라 초기화 함수
        function initCamera() {
            // 이미 초기화되어 있으면 무시
            if (camera) return;
            
            console.log("카메라 초기화 시작");
            
            // 카메라 인스턴스 생성
            camera = new Camera();
            
            // 이미지 수신 완료 콜백 설정
            camera.setOnImageComplete((blob) => {
                console.log("이미지 수신 완료:", blob.size, "바이트");
                
                // Blob URL 생성하여 이미지에 표시
                const url = URL.createObjectURL(blob);
                cameraView.src = url;
                
                // 메모리 누수 방지를 위해 URL 객체 해제 (3초 후)
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 3000);
            });
            
            // 스트리밍 상태 변경 콜백 설정
            camera.setOnStreamingStateChange((isStreaming) => {
                console.log("스트리밍 상태 변경:", isStreaming);
                // 버튼 상태 업데이트
                streamBtn.disabled = isStreaming;
                stopBtn.disabled = !isStreaming;
            });
            
            console.log("카메라 초기화 완료");
        }
        
        // 센서 타이머 중지
        function stopSensorTimer() {
            if (sensorDataTimer) {
                console.log("센서 데이터 타이머 중지");
                clearInterval(sensorDataTimer);
                sensorDataTimer = null;
            }
        }
        
        // LED 켜기 버튼 이벤트 리스너
        ledOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!led) {
                console.log("LED가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initLED();
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => led.turnOn());
                console.log("LED 켜기 성공");
            } catch (error) {
                console.error("LED 켜기 실패:", error);
                alert("LED 켜기에 실패했습니다: " + error.message);
            }
        });
        
        // LED 끄기 버튼 이벤트 리스너
        ledOffBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!led) {
                console.log("LED가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initLED();
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => led.turnOff());
                console.log("LED 끄기 성공");
            } catch (error) {
                console.error("LED 끄기 실패:", error);
                alert("LED 끄기에 실패했습니다: " + error.message);
            }
        });
        
        // LED 깜빡임 버튼 이벤트 리스너 추가
        document.getElementById('ledBlinkBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!led) {
                console.log("LED가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initLED();
            }
            
            try {
                // blinkLED 함수 호출 (500ms 간격으로 깜빡임)
                blinkLED(led, blinkInterval.value);
                console.log("LED 깜빡임 시작 (500ms 간격)");
            } catch (error) {
                console.error("LED 깜빡임 시작 실패:", error);
                alert("LED 깜빡임 시작에 실패했습니다: " + error.message);
            }
        });
        
        // LED 깜빡임 중지 버튼 이벤트 리스너 추가
        const ledBlinkStopBtn = document.getElementById('ledBlinkStopBtn');
        ledBlinkStopBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!led) {
                console.log("LED가 초기화되지 않았습니다.");
                return;
            }
            
            try {
                // stopBlinking 함수 호출하여 깜빡임 중지
                stopBlinking(led);
                console.log("LED 깜빡임 중지 성공");
            } catch (error) {
                console.error("LED 깜빡임 중지 실패:", error);
                alert("LED 깜빡임 중지에 실패했습니다: " + error.message);
            }
        });
        
        // LED 밝기 설정 버튼 이벤트 리스너 추가
        document.getElementById('ledBrightnessBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!led) {
                console.log("LED가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initLED();
            }
            
            try {
                // 밝기 값 가져오기 (0-100 사이의 값)
                const brightness = parseInt(document.getElementById('ledBrightness').value);
                
                // 값 검증
                if (isNaN(brightness) || brightness < 0 || brightness > 100) {
                    alert("밝기는 0에서 100 사이의 값이어야 합니다.");
                    return;
                }
                
                // 재시도 로직 적용
                await executeWithRetry(() => led.setBrightness(brightness));
                console.log(`LED 밝기 설정 성공: ${brightness}%`);
            } catch (error) {
                console.error("LED 밝기 설정 실패:", error);
                alert("LED 밝기 설정에 실패했습니다: " + error.message);
            }
        });
        
        // 연결/해제 토글 버튼 이벤트 리스너
        connectBtn.addEventListener('click', async () => {
            if (bleManager.isConnected) {
                // 연결 해제
                bleManager.disconnect();
            } else {
                // 연결
                try {
                    await bleManager.connect();
                } catch (error) {
                    console.error('연결 실패:', error);
                }
            }
        });
        
        // 서보모터 각도 설정 버튼 이벤트 리스너
        servoBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!servo) {
                console.log("서보모터가 초기화되지 않았습니다. 초기화를 시도합니다.");
                // initServo(21); // 핀 번호 21 가정
            }
            
            try {
                // 슬라이더에서 각도 값 가져오기
                const angle = parseInt(document.getElementById('servoSlider').value);
                // 재시도 로직 적용
                await executeWithRetry(() => servo.setAngle(angle));
                console.log(`서보모터 각도 설정 성공: ${angle}도`);
            } catch (error) {
                console.error("서보모터 각도 설정 실패:", error);
                alert("서보모터 각도 설정에 실패했습니다: " + error.message);
            }
        });
        
        // 스트리밍 시작 버튼 이벤트 리스너
        streamBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!camera) {
                console.log("카메라가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initCamera();
            }
            
            try {
                // streamInterval 입력 필드에서 값 가져오기
                const intervalValue = parseInt(document.getElementById('streamInterval').value);
                console.log(`스트리밍 간격 설정: ${intervalValue}ms`);
                
                // 먼저 스트리밍 간격 설정
                await executeWithRetry(() => camera.setStreamInterval(intervalValue));
                
                // 스트리밍 시작
                await executeWithRetry(() => camera.startStreaming());
                console.log("카메라 스트리밍 시작 성공");
            } catch (error) {
                console.error("카메라 스트리밍 시작 실패:", error);
                alert("카메라 스트리밍 시작에 실패했습니다: " + error.message);
            }
        });
        
        // 스트리밍 중지 버튼 이벤트 리스너
        stopBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!camera) {
                console.log("카메라가 초기화되지 않았습니다.");
                return;
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => camera.stopStreaming());
                console.log("카메라 스트리밍 중지 성공");
            } catch (error) {
                console.error("카메라 스트리밍 중지 실패:", error);
                alert("카메라 스트리밍 중지에 실패했습니다: " + error.message);
            }
        });
        
        // 사진 촬영 버튼 이벤트 리스너
        snapBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!camera) {
                console.log("카메라가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initCamera();
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => camera.takeSnapshot());
                console.log("사진 촬영 요청 성공");
            } catch (error) {
                console.error("사진 촬영 요청 실패:", error);
                alert("사진 촬영 요청에 실패했습니다: " + error.message);
            }
        });
        // var val;
        // LightSensorOnBtn.addEventListener('click', async () => {
        //     getLightSensorValue(lightSensor)
        //         .then(value => {
        //             lightLabel.textContent = value; // value is guaranteed to be valid here
        //             //val = value;
        //             console.log("조도센서 값:", value);
        //         })
        //         .catch(error => {
        //             console.log("센서 값을 가져올 수 없습니다:", error.message);
        //         });
        //         //lightLabel.textContent = val; 
        //         //console.log("조도센서 값val:", val);
        // });

        LightSensorOnBtn.addEventListener('click', async () => {
            try {
                lightLabel.textContent = await getValidLightSensorValue(lightSensor);
                
                
                
                
            } catch (error) {
                lightLabel.textContent = "값을 가져올 수 없음";
            }
        });
        UltraOnBtn.addEventListener('click', async () => {
            ultraLabel.textContent = `${await getValidUltrasonicValue(ultraSensor)}cm`;
        });

        DHTOnBtn.addEventListener('click', async () => {
            const dhtData = await getValidDHTValue(dhtSensor);
            tempLabel.textContent = dhtData.temperature;
            humidLabel.textContent = dhtData.humidity;
        });

        DustOnBtn.addEventListener('click', async () => {
            // 먼지 센서 값도 추가
            try {
                if (dustSensor.isCalibrated()) {
                    const dustData = await getValidDustValue(dustSensor);
                    dustLabel.textContent = dustData.density !== null ? 
                    `${dustData.density.toFixed(2)} μg/m³` : "측정 불가";
                } else {
                    dustLabel.textContent = "보정 중";
                }
            } catch (e) {
                console.error("먼지 센서 값 가져오기 실패:", e);
            }
        });

        // 토양수분센서 테스트 버튼 이벤트 리스너
        SoilOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!soilSensor) {
                console.log("토양수분센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initSoilSensor(2); // ADC 핀 2 사용
            }
            
            try {
                const soilData = await getValidSoilMoistureValue(soilSensor);
                if (soilData) {
                    const moistureText = soilData.moisture !== null ? `${soilData.moisture.toFixed(1)}%` : 'N/A';
                    const voltageText = soilData.voltage !== null ? `${soilData.voltage.toFixed(3)}V` : 'N/A';
                    const rawText = soilData.rawValue !== null ? soilData.rawValue : 'N/A';
                    soilLabel.textContent = `${moistureText} (${voltageText}, ${rawText})`;
                } else {
                    soilLabel.textContent = "데이터 없음";
                }
                console.log("토양수분센서 값:", soilData);
            } catch (error) {
                console.error("토양수분센서 값 가져오기 실패:", error);
                soilLabel.textContent = "측정 실패";
            }
        });

        // 토양수분센서 건조 보정 버튼 이벤트 리스너
        SoilCalibrateDryBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!soilSensor) {
                console.log("토양수분센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initSoilSensor(2); // ADC 핀 2 사용
            }
            
            try {
                soilLabel.textContent = "건조 보정 중...";
                await soilSensor.calibrateDry();
                console.log("토양수분센서 건조 보정 요청 성공");
                setTimeout(() => {
                    soilLabel.textContent = "건조 보정 완료";
                }, 2000);
            } catch (error) {
                console.error("토양수분센서 건조 보정 실패:", error);
                soilLabel.textContent = "건조 보정 실패";
                alert("토양수분센서 건조 보정에 실패했습니다: " + error.message);
            }
        });

        // 토양수분센서 습윤 보정 버튼 이벤트 리스너
        SoilCalibrateWetBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!soilSensor) {
                console.log("토양수분센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initSoilSensor(2); // ADC 핀 2 사용
            }
            
            try {
                soilLabel.textContent = "습윤 보정 중...";
                await soilSensor.calibrateWet();
                console.log("토양수분센서 습윤 보정 요청 성공");
                setTimeout(() => {
                    soilLabel.textContent = "습윤 보정 완료";
                }, 2000);
            } catch (error) {
                console.error("토양수분센서 습윤 보정 실패:", error);
                soilLabel.textContent = "습윤 보정 실패";
                alert("토양수분센서 습윤 보정에 실패했습니다: " + error.message);
            }
        });

        // 빗방울센서 테스트 버튼 이벤트 리스너
        RainOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!rainSensor) {
                console.log("빗방울센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initRainSensor(2); // ADC 핀 2 사용 (BLE 연결 시와 동일)
            }
            
            try {
                const rainData = await getValidRainSensorValue(rainSensor);
                if (rainData) {
                    const rainText = rainData.rainPercentage !== null ? `${rainData.rainPercentage.toFixed(1)}%` : 'N/A';
                    const voltageText = rainData.voltage !== null ? `${rainData.voltage.toFixed(3)}V` : 'N/A';
                    const rawText = rainData.rawValue !== null ? rainData.rawValue : 'N/A';
                    rainLabel.textContent = `${rainText} (${voltageText}, ${rawText})`;
                } else {
                    rainLabel.textContent = "데이터 없음";
                }
                console.log("빗방울센서 값:", rainData.rainPercentage);
            } catch (error) {
                console.error("빗방울센서 값 가져오기 실패:", error);
                rainLabel.textContent = "측정 실패";
            }
        });

        // 센서 시작 버튼 이벤트 리스너
        sensorOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            console.log("센서 데이터 요청 시작");
            
            // 이미 타이머가 실행 중이면 중지
            stopSensorTimer();
            
            // 주기적인 데이터 요청 및 UI 업데이트 타이머
            sensorDataTimer = setInterval(() => {
                // 타이머 내부에서도 연결 상태 확인
                if (bleManager.isConnected) {
                    // 조도센서 데이터 요청 - 재시도 로직 적용
                    getLightSensorValue(lightSensor).then(value => {
                        if (value !== null && value !== undefined) {
                            lightLabel.textContent = value;
                        } else {
                            console.log("센서 값을 가져올 수 없습니다");
                        }
                    });
                    // executeWithRetry(() => lightSensor.getStatus())
                    //     .then(() => {
                    //         // 안전한 접근을 위해 null 체크 추가
                    //         if (lightSensor && typeof lightSensor.getAnalog === 'function') {
                    //             lightLabel.textContent = `조도센서 값: ${lightSensor.getAnalog()}`;
                    //         }
                    //     }).catch(() => {
                    //         console.log("조도센서 데이터 요청 중 오류 발생");
                    //     });
                    
                    // 초음파센서 데이터 요청 - 재시도 로직 적용
                    getUltrasonicSensorValue(ultraSensor).then(distance => {
                        console.log("초음파 센서 값11111:", distance);
                        if (distance !== null) {
                            if (distance == 0) {
                                distance = 900;
                                console.log("초음파 센서 값이 0입니다. 900으로 변경합니다.");
                            }
                            ultraLabel.textContent = `${distance}cm`;
                        } else {
                            console.log("초음파 센서 값을 가져올 수 없습니다");
                        }
                    });
                    
                    // 온습도센서 데이터 요청 - 재시도 로직 적용
                    // getDHTSensorValue(dhtSensor).then(result => {
                    //     if (result) {
                    //         // 온도 표시
                    //         if (result.temperature !== null) {
                    //             tempLabel.textContent = `${result.temperature}°C`;
                    //         }
                            
                    //         // 습도 표시
                    //         if (result.humidity !== null) {
                    //             humidLabel.textContent = `${result.humidity}%`;
                    //         }
                    //     } else {
                    //         console.log("온습도 센서 값을 가져올 수 없습니다");
                    //     }
                    // });
                    
                    // 먼지 센서 데이터 요청 - 재시도 로직 적용
                    getDustSensorValue(dustSensor).then(result => {
                        if (result && result.density !== null) {
                            dustLabel.textContent = `${result.density.toFixed(2)} μg/m³`;
                        } else {
                            console.log("먼지 센서 값을 가져올 수 없습니다");
                        }
                    });

                    // 자이로센서 데이터 요청 - 재시도 로직 적용
                    if (gyroSensor) {
                        getValidGyroValue(gyroSensor).then(gyroData => {
                            if (gyroData) {
                                gyroLabel.textContent = `X:${gyroData.x.toFixed(2)}, Y:${gyroData.y.toFixed(2)}, Z:${gyroData.z.toFixed(2)}, Roll:${gyroData.roll?.toFixed(2) || 'N/A'}, Pitch:${gyroData.pitch?.toFixed(2) || 'N/A'}`;
                            }
                        }).catch(error => {
                            console.error("자이로센서 데이터 요청 중 오류 발생:", error);
                        });
                    }

                    // 심장박동 센서 데이터 요청
                    if (heartSensor) {
                        getValidHeartRateValue(heartSensor).then(bpm => {
                            if (bpm !== null) {
                                heartLabel.textContent = `${bpm} BPM`;
                            } else {
                                console.log("심장박동 센서 값을 가져올 수 없습니다");
                            }
                        }).catch(error => {
                            console.error("심장박동 센서 데이터 요청 중 오류 발생:", error);
                        });
                    }

                    // 토양수분센서 데이터 요청
                    if (soilSensor) {
                        getValidSoilMoistureValue(soilSensor).then(soilData => {
                            if (soilData) {
                                const moistureText = soilData.moisture !== null ? `${soilData.moisture.toFixed(1)}%` : 'N/A';
                                const voltageText = soilData.voltage !== null ? `${soilData.voltage.toFixed(3)}V` : 'N/A';
                                soilLabel.textContent = `${moistureText} (${voltageText})`;
                            } else {
                                console.log("토양수분센서 값을 가져올 수 없습니다");
                            }
                        }).catch(error => {
                            console.error("토양수분센서 데이터 요청 중 오류 발생:", error);
                        });
                    }

                    // 빗방울센서 데이터 요청
                    if (rainSensor) {
                        getValidRainSensorValue(rainSensor).then(rainData => {
                            if (rainData) {
                                const rainText = rainData.rainPercentage !== null ? `${rainData.rainPercentage.toFixed(1)}%` : 'N/A';
                                const voltageText = rainData.voltage !== null ? `${rainData.voltage.toFixed(3)}V` : 'N/A';
                                rainLabel.textContent = `${rainText} (${voltageText})`;
                            } else {
                                console.log("빗방울센서 값을 가져올 수 없습니다");
                            }
                        }).catch(error => {
                            console.error("빗방울센서 데이터 요청 중 오류 발생:", error);
                        });
                    }
                } else {
                    // 연결이 끊어진 경우 타이머 중지
                    console.log("연결이 끊어졌습니다. 타이머를 중지합니다.");
                    stopSensorTimer();
                }
            }, 500);
            
            console.log("센서 데이터 요청 타이머 시작됨");
        });
        
        // 센서 중지 버튼 이벤트 리스너
        sensorOffBtn.addEventListener('click', () => {
            console.log("센서 데이터 요청 중지");
            stopSensorTimer();
        });
        
        // // 먼지 센서 보정 버튼 이벤트 리스너
        // dustCalibrateBtn.addEventListener('click', async () => {
        //     if (!bleManager.isConnected) {
        //         alert("BLE 장치에 먼저 연결해주세요.");
        //         return;
        //     }
            
        //     if (!dustSensor) {
        //         console.log("먼지 센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
        //         initDustSensor(20, 19); // 기본 LED핀 39, ADC핀 19 사용
        //     }
            
        //     try {
        //         dustLabel.textContent = "보정 중...";
        //         // 재시도 로직 적용
        //         await executeWithRetry(() => dustSensor.calibrate());
        //         console.log("먼지 센서 보정 요청 성공");
        //         setTimeout(() => {
        //             // 보정 완료 후 현재 상태 측정 시도
        //             getDustSensorValue(dustSensor).then(result => {
        //                 if (result && result.density !== null) {
        //                     dustLabel.textContent = `${result.density.toFixed(2)} μg/m³`;
        //                 } else {
        //                     dustLabel.textContent = "보정 완료 (값 측정 필요)";
        //                 }
        //             });
        //         }, 1000);
        //     } catch (error) {
        //         console.error("먼지 센서 보정 요청 실패:", error);
        //         dustLabel.textContent = "보정 실패";
        //         alert("먼지 센서 보정에 실패했습니다: " + error.message);
        //     }
        // });
        
        
        // 페이지 로드 완료 시 실행
        window.onload = function() {
            console.log("페이지 로드 완료");
            
            // 초기에 버튼 비활성화 설정
            streamBtn.disabled = true;
            stopBtn.disabled = true;
            snapBtn.disabled = true;
            sensorOnBtn.disabled = true;
            sensorOffBtn.disabled = true;
            HeartStreamStopBtn.disabled = true;
            GyroStreamStopBtn.disabled = true;
            
            // 버저 버튼 초기 비활성화 (초기화 버튼 제외)
            document.getElementById('buzzerBeepBtn').disabled = true;
            document.getElementById('buzzerMelodyBtn').disabled = true;
            document.getElementById('buzzerStopBtn').disabled = true;
            
            lightLabel.textContent = '측정 전';
            ultraLabel.textContent = '측정 전';
            tempLabel.textContent = '측정 전';
            humidLabel.textContent = '측정 전';
            dustLabel.textContent = '측정 전';
            gyroLabel.textContent = '측정 전';
            heartLabel.textContent = '측정 전';
            soilLabel.textContent = '측정 전';
            rainLabel.textContent = '측정 전';
        };

        // 네오픽셀 초기화 함수
        function initNeoPixel(pin, numPixels = 4) {
            // 이미 초기화되어 있으면 무시
            if (neoPixel) return;
            
            console.log("네오픽셀 초기화 시작");
            
            // 네오픽셀 객체 생성 - 클래스 인스턴스 방식으로 변경
            neoPixel = new NeoPixel();
            
            // 네오픽셀 핀 설정
            neoPixel.setPin(pin, numPixels)
                .then(() => {
                    console.log("네오픽셀 핀 설정 완료");
                })
                .catch(err => {
                    console.error("네오픽셀 초기화 실패:", err);
                });
            
            console.log("네오픽셀 초기화 완료");
        }

        // 16진수 색상을 RGB 컴포넌트로 변환하는 함수
        function hexToRgb(hex) {
            // #RRGGBB 형식에서 RGB 값 추출
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            return { r, g, b };
        }

        // RGB 텍스트 필드와 컬러 픽커 연동 설정
        for (let i = 1; i <= 4; i++) {
            const colorInput = document.getElementById(`color${i}`);
            const colorPicker = document.getElementById(`colorPicker${i}`);
            
            // 텍스트 필드 값 변경 시 컬러 픽커 업데이트
            colorInput.addEventListener('change', function() {
                try {
                    // RGB 텍스트 값에서 컬러 픽커 값 계산
                    const rgbValues = this.value.split(',').map(v => parseInt(v.trim()));
                    if (rgbValues.length >= 3) {
                        const [r, g, b] = rgbValues;
                        if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                            // RGB 값을 16진수로 변환
                            const hexColor = '#' + 
                                r.toString(16).padStart(2, '0') + 
                                g.toString(16).padStart(2, '0') + 
                                b.toString(16).padStart(2, '0');
                            colorPicker.value = hexColor;
                        }
                    }
                } catch (e) {
                    console.error(`RGB 텍스트 파싱 오류:`, e);
                }
            });
            
            // 컬러 픽커 값 변경 시 텍스트 필드 업데이트
            colorPicker.addEventListener('input', function() {
                const rgb = hexToRgb(this.value);
                colorInput.value = `${rgb.r},${rgb.g},${rgb.b}`;
            });
        }

        // 네오픽셀 켜기 버튼 이벤트 리스너
        document.getElementById('neopixelOnBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!neoPixel) {
                initNeoPixel(3); // 핀 번호 3 사용
            }
            
            try {
                // 각 LED에 색상 설정
                for (let i = 1; i <= 4; i++) {
                    const colorInput = document.getElementById(`color${i}`);
                    const rgbValues = colorInput.value.split(',').map(v => parseInt(v.trim()));
                    
                    if (rgbValues.length >= 3) {
                        const [r, g, b] = rgbValues;
                        if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                            await neoPixel.setPixelColor1(i-1, r, g, b);
                            console.log(`LED ${i} 색상 설정: RGB(${r},${g},${b})`);
                        }
                    }
                }
            } catch (error) {
                console.error("네오픽셀 설정 오류:", error);
                alert("네오픽셀 설정 중 오류가 발생했습니다: " + error.message);
            }
        });

        // 네오픽셀 끄기 버튼 이벤트 리스너
        document.getElementById('neopixelOffBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!neoPixel) {
                initNeoPixel(3); // 핀 번호 3 가정
            }
            
            try {
                await neoPixel.turnOff();
                console.log("네오픽셀 끄기 성공");
                
                // 모든 색상 입력을 0,0,0으로 초기화
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`color${i}`).value = "0,0,0";
                    document.getElementById(`colorPicker${i}`).value = "#000000";
                }
            } catch (error) {
                console.error("네오픽셀 끄기 오류:", error);
                alert("네오픽셀 끄기 중 오류가 발생했습니다: " + error.message);
            }
        });

        // 무지개 효과 버튼 이벤트 리스너
        document.getElementById('rainbowBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!neoPixel) {
                initNeoPixel(3); // 핀 번호 3 사용
            }
            
            try {
                await neoPixel.setRainbow();
                console.log("무지개 효과 설정 성공");
            } catch (error) {
                console.error("무지개 효과 설정 오류:", error);
                alert("무지개 효과 설정 중 오류가 발생했습니다: " + error.message);
            }
        });

        // 서보모터 슬라이더 값 변경 처리
        const servoSlider = document.getElementById('servoSlider');
        const servoAngleLabel = document.getElementById('servoAngleLabel');

        // 슬라이더 값 변경 시 라벨 업데이트
        servoSlider.addEventListener('input', function() {
            servoAngleLabel.textContent = this.value + '°';
        });

        // 버저 초기화 함수
        function initBuzzer() {
            // 이미 초기화되어 있으면 무시
            if (buzzer) return;
            
            console.log("버저 초기화 시작");
            
            // 버저 인스턴스 생성
            buzzer = new Buzzer();
            
            // 버저 초기화 - 비동기 작업이므로 Promise 반환
            buzzer.init()
                .then(() => {
                    console.log("버저 초기화 완료");
                    // 버저 UI 버튼 활성화
                    document.getElementById('buzzerBeepBtn').disabled = false;
                    document.getElementById('buzzerMelodyBtn').disabled = false;
                    document.getElementById('buzzerStopBtn').disabled = false;
                })
                .catch(err => {
                    console.error("버저 초기화 실패:", err);
                    alert("버저 초기화에 실패했습니다: " + err.message);
                });
        }

        // 버저 버튼 이벤트 리스너 추가
        document.getElementById('buzzerInitBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            initBuzzer();
        });

        // 연속 비프음 시작 버튼 이벤트 리스너 추가
        document.getElementById('buzzerBeepOnBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!buzzer) {
                alert("버저를 먼저 초기화해주세요.");
                return;
            }
            
            try {
                // 주파수 값 가져오기 (기본 비프음과 동일한 주파수 값 사용)
                const frequency = 2000;
                
                // 재시도 로직 적용
                await executeWithRetry(() => buzzer.playBeepOn(frequency));
                console.log(`연속 비프음 시작: ${frequency}Hz`);
            } catch (error) {
                console.error("연속 비프음 시작 실패:", error);
                alert("연속 비프음 시작에 실패했습니다: " + error.message);
            }
        });

        document.getElementById('buzzerBeepBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!buzzer) {
                alert("버저를 먼저 초기화해주세요.");
                return;
            }
            
            try {
                // 입력 필드에서 값 가져오기
                const count = parseInt(document.getElementById('beepCount').value);
                const frequency = parseInt(document.getElementById('beepFreq').value);
                const duration = parseInt(document.getElementById('beepDuration').value);
                const interval = parseInt(document.getElementById('beepInterval').value);
                
                // 재시도 로직 적용
                await executeWithRetry(() => buzzer.beep(count, frequency, duration, interval));
                console.log(`비프음 재생 시작: ${count}회, ${frequency}Hz, ${duration}ms, ${interval}ms 간격`);
            } catch (error) {
                console.error("비프음 재생 실패:", error);
                alert("비프음 재생에 실패했습니다: " + error.message);
            }
        });

        document.getElementById('buzzerMelodyBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!buzzer) {
                alert("버저를 먼저 초기화해주세요.");
                return;
            }
            
            try {
                // 입력 필드에서 값 가져오기
                const melodyName = document.getElementById('melodySelect').value;
                const tempo = parseInt(document.getElementById('melodyTempo').value);
                
                // 재시도 로직 적용
                await executeWithRetry(() => buzzer.playMelody(melodyName, tempo));
                console.log(`멜로디 재생 시작: ${melodyName}, 템포 ${tempo}`);
            } catch (error) {
                console.error("멜로디 재생 실패:", error);
                alert("멜로디 재생에 실패했습니다: " + error.message);
            }
        });

        document.getElementById('buzzerStopBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!buzzer) {
                alert("버저를 먼저 초기화해주세요.");
                return;
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => buzzer.stop());
                console.log("버저 재생 중지");
            } catch (error) {
                console.error("버저 중지 실패:", error);
                alert("버저 중지에 실패했습니다: " + error.message);
            }
        });

        // DC 모터 초기화 함수
        function initDCMotor(pin) {
            // 이미 초기화되어 있으면 무시
            if (dcMotor) return;
            
            console.log("DC 모터 초기화 시작");
            
            // DC 모터 인스턴스 생성
            dcMotor = new DCMotor();
            
            // DC 모터 핀 설정
            dcMotor.setPin(pin).then(() => {
                console.log("DC 모터 핀 설정 완료");
                // 초기 상태로 모터 정지
                return dcMotor.stop();
            }).then(() => {
                console.log("DC 모터 초기 상태(정지) 설정 완료");
            }).catch(err => {
                console.error("DC 모터 초기화 실패:", err);
            });
            
            console.log("DC 모터 초기화 완료");
        }

        // DC 모터 속도 설정 버튼 이벤트 리스너
        document.getElementById('dcMotorSetSpeedBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!dcMotor) {
                console.log("DC 모터가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initDCMotor(39); // 핀 번호 39 사용
            }
            
            try {
                // 속도 값 가져오기 (0-100 사이의 값)
                const speed = parseInt(document.getElementById('dcMotorSpeed').value);
                
                // 값 검증
                if (isNaN(speed) || speed < 0 || speed > 100) {
                    alert("속도는 0에서 100 사이의 값이어야 합니다.");
                    return;
                }
                
                // 재시도 로직 적용
                await executeWithRetry(() => dcMotor.setSpeed(speed));
                console.log(`DC 모터 속도 설정 성공: ${speed}%`);
            } catch (error) {
                console.error("DC 모터 속도 설정 실패:", error);
                alert("DC 모터 속도 설정에 실패했습니다: " + error.message);
            }
        });
        
        // DC 모터 정지 버튼 이벤트 리스너
        document.getElementById('dcMotorStopBtn').addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!dcMotor) {
                console.log("DC 모터가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initDCMotor(39); // 핀 번호 39 사용
            }
            
            try {
                // 재시도 로직 적용
                await executeWithRetry(() => dcMotor.stop());
                console.log("DC 모터 정지 성공");
            } catch (error) {
                console.error("DC 모터 정지 실패:", error);
                alert("DC 모터 정지에 실패했습니다: " + error.message);
            }
        });

        // 자이로센서 초기화 함수
        function initGyroSensor(sdaPin, sclPin) {
            // 이미 초기화되어 있으면 무시
            if (gyroSensor) return;
            
            console.log("자이로센서 초기화 시작");
            
            // 자이로센서 인스턴스 생성
            gyroSensor = new GyroSensor();
            
            // 자이로센서 핀 설정 (I2C 인터페이스를 위한 SDA, SCL 핀)
            gyroSensor.setPin(sdaPin, sclPin).then(() => {
                console.log("자이로센서 핀 설정 완료");
                // 초기 상태 요청
                return gyroSensor.getStatus();
            }).catch(err => {
                console.error("자이로센서 초기화 실패:", err);
            });
            
            console.log("자이로센서 초기화 완료");
        }

        // 자이로센서 테스트 버튼 이벤트 리스너 추가
        GyroOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!gyroSensor) {
                console.log("자이로센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initGyroSensor(21, 47); // SDA 핀 21, SCL 핀 47 사용
            }
            
            try {
                const gyroData = await getValidGyroValue(gyroSensor);
                gyroLabel.textContent = `X:${gyroData.x.toFixed(2)}, Y:${gyroData.y.toFixed(2)}, Z:${gyroData.z.toFixed(2)}, Roll:${gyroData.roll?.toFixed(2) || 'N/A'}, Pitch:${gyroData.pitch?.toFixed(2) || 'N/A'}`;
                console.log("자이로센서 값:", gyroData);
            } catch (error) {
                console.error("자이로센서 값 가져오기 실패:", error);
                gyroLabel.textContent = "측정 실패";
            }
        });

        // 자이로센서 스트림 시작 버튼 이벤트 리스너
        GyroStreamOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!gyroSensor) {
                console.log("자이로센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initGyroSensor(21, 47); // SDA 핀 21, SCL 핀 47 사용
            }
            
            try {
                await gyroSensor.startStreaming();
                console.log("자이로센서 스트리밍 시작");
                
                // 버튼 상태 업데이트
                GyroStreamOnBtn.disabled = true;
                GyroStreamStopBtn.disabled = false;
            } catch (error) {
                console.error("자이로센서 스트리밍 시작 실패:", error);
                alert("자이로센서 스트리밍 시작에 실패했습니다: " + error.message);
            }
        });

        // 자이로센서 스트림 중지 버튼 이벤트 리스너
        GyroStreamStopBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!gyroSensor) {
                console.log("자이로센서가 초기화되지 않았습니다.");
                return;
            }
            
            try {
                await gyroSensor.stopStreaming();
                console.log("자이로센서 스트리밍 중지");
                
                // 버튼 상태 업데이트
                GyroStreamOnBtn.disabled = false;
                GyroStreamStopBtn.disabled = true;
                
                // 상태 표시 업데이트
                gyroLabel.textContent = "스트리밍 중지됨";
            } catch (error) {
                console.error("자이로센서 스트리밍 중지 실패:", error);
                alert("자이로센서 스트리밍 중지에 실패했습니다: " + error.message);
            }
        });

        // 심장박동 센서 테스트 버튼 이벤트 리스너
        HeartOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!heartSensor) {
                console.log("심장박동 센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initHeartRateSensor(21, 47); // SDA 핀 21, SCL 핀 47 사용 (I2C)
            }
            
            try {
                const bpm = await getValidHeartRateValue(heartSensor);
                heartLabel.textContent = `${bpm} BPM`;
                console.log("심장박동 값:", bpm);
            } catch (error) {
                console.error("심장박동 센서 값 가져오기 실패:", error);
                heartLabel.textContent = "측정 실패";
            }
        });

        // 심장박동 스트림 시작 버튼 이벤트 리스너
        HeartStreamOnBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!heartSensor) {
                console.log("심장박동 센서가 초기화되지 않았습니다. 초기화를 시도합니다.");
                initHeartRateSensor(21, 47); // SDA 핀 21, SCL 핀 47 사용 (I2C)
            }
            
            try {
                await heartSensor.startStreaming();
                console.log("심장박동 센서 스트리밍 시작");
                
                // // 스트리밍 데이터 수신을 위한 콜백 등록
                // heartSensor.onStreamingData((bpm) => {
                //     //heartLabel.textContent = `${bpm}`;
                //     console.log("실시간 심장박동:", bpm);
                // });
                
                // 버튼 상태 업데이트
                HeartStreamOnBtn.disabled = true;
                HeartStreamStopBtn.disabled = false;
            } catch (error) {
                console.error("심장박동 센서 스트리밍 시작 실패:", error);
                alert("심장박동 센서 스트리밍 시작에 실패했습니다: " + error.message);
            }
        });

        // 심장박동 스트림 중지 버튼 이벤트 리스너
        HeartStreamStopBtn.addEventListener('click', async () => {
            if (!bleManager.isConnected) {
                alert("BLE 장치에 먼저 연결해주세요.");
                return;
            }
            
            if (!heartSensor) {
                console.log("심장박동 센서가 초기화되지 않았습니다.");
                return;
            }
            
            try {
                await heartSensor.stopStreaming();
                console.log("심장박동 센서 스트리밍 중지");
                
                // 버튼 상태 업데이트
                HeartStreamOnBtn.disabled = false;
                HeartStreamStopBtn.disabled = true;
                
                // 상태 표시 업데이트
                heartLabel.textContent = "스트리밍 중지됨";
            } catch (error) {
                console.error("심장박동 센서 스트리밍 중지 실패:", error);
                alert("심장박동 센서 스트리밍 중지에 실패했습니다: " + error.message);
            }
        });

        // 연결 상태 변경 시 버튼 텍스트 업데이트
        bleManager.onConnectionChange((connected) => {
            connectBtn.textContent = connected ? '해제' : '연결';
            
            // 카메라 버튼 상태 업데이트
            streamBtn.disabled = !connected;
            stopBtn.disabled = !connected || (camera ? !camera.isStreamingActive() : true);
            snapBtn.disabled = !connected;
            
            // 센서 버튼 상태 업데이트
            sensorOnBtn.disabled = !connected;
            sensorOffBtn.disabled = !connected;
            
            if (connected) {
                console.log("BLE 연결됨 - 센서 초기화 시작");
                
                // 연결 상태에서는 bleNameInput을 읽기 전용으로 설정
                const bleNameInput = document.getElementById('bleNameInput');
                if (bleNameInput) {
                    // 장치 이름이 저장되어 있지 않다면 기본값 설정
                    if (!bleNameInput.value) {
                        bleNameInput.value = bleManager.device ? bleManager.device.name : "연결됨";
                    }
                    bleNameInput.readOnly = true;
                }
                
                // BLE 연결됨 - 모든 센서 초기화
                //initLightSensor(1);
                //initUltrasonicSensor(40, 41); // 트리거 핀 40, 에코 핀 41으로 가정
                // initDHTSensor(14);          // DHT 센서 핀 38로 가정
                //initDustSensor(20, 19); // 기본 LED핀 39, ADC핀 19 사용
                //initLED();
                //initServo(48);             // 서보모터 초기화 추가, 핀 21 사용 가정
                //initCamera();              // 카메라 초기화 추가
                //initNeoPixel(47);          // 네오픽셀 초기화 추가, 핀 3 가정 (추가된 부분)
                //initDCMotor(39);           // DC 모터 초기화 추가, 핀 5 사용 가정
                //initGyroSensor(21, 47);    // 자이로센서 초기화 추가, SDA 핀 21, SCL 핀 47 사용 가정
                //initHeartRateSensor(21, 47); // 심장박동 센서 초기화, SDA 핀 21, SCL 핀 47 사용
                //initSoilSensor(2);         // 토양수분센서 초기화 추가, ADC 핀 2 사용
                initRainSensor(2);         // 빗방울센서 초기화 추가, ADC 핀 2 사용
                
                // 센서 데이터 요청 타이머는 sensorOnBtn 클릭 시 시작됨
            } else {
                // BLE 연결 해제됨 - 정리 작업
                console.log("연결 해제됨 - 센서 정리 및 타이머 중지");
                stopSensorTimer();  // 타이머 먼저 중지
                
                // 카메라 스트리밍 중지 시도
                if (camera && camera.isStreamingActive()) {
                    try {
                        camera.stopStreaming().catch(e => console.error("스트리밍 중지 오류:", e));
                    } catch (e) {
                        console.error("스트리밍 중지 오류:", e);
                    }
                }
                
                // 버저 중지 시도
                if (buzzer) {
                    try {
                        buzzer.stop().catch(e => console.error("버저 중지 오류:", e));
                    } catch (e) {
                        console.error("버저 중지 오류:", e);
                    }
                }
                
                // DC 모터 중지 시도
                if (dcMotor) {
                    try {
                        dcMotor.stop().catch(e => console.error("DC 모터 중지 오류:", e));
                    } catch (e) {
                        console.error("DC 모터 중지 오류:", e);
                    }
                }
                
                lightSensor = null; // 센서 객체 정리
                ultraSensor = null; // 초음파센서 객체 정리
                dhtSensor = null;   // 온습도센서 객체 정리
                led = null;        // LED 객체 정리
                servo = null;      // 서보모터 객체 정리
                camera = null;     // 카메라 객체 정리
                dustSensor = null; // 먼지 센서 객체 정리
                neoPixel = null;   // 네오픽셀 객체 정리 (추가된 부분)
                buzzer = null;     // 버저 객체 정리
                dcMotor = null;    // DC 모터 객체 정리
                gyroSensor = null; // 자이로센서 객체 정리
                heartSensor = null; // 심장박동 센서 객체 정리
                soilSensor = null; // 토양수분센서 객체 정리
                rainSensor = null; // 빗방울센서 객체 정리
                
                // 버튼 상태 업데이트
                streamBtn.disabled = true;
                stopBtn.disabled = true;
                snapBtn.disabled = true;
                sensorOnBtn.disabled = true;
                sensorOffBtn.disabled = true;
                // HeartStreamOnBtn.disabled = true;
                // HeartStreamStopBtn.disabled = true;
                // GyroStreamOnBtn.disabled = true;
                // GyroStreamStopBtn.disabled = true;
                
                // 레이블 초기화
                lightLabel.textContent = '측정 전';
                ultraLabel.textContent = '측정 전';
                tempLabel.textContent = '측정 전';
                humidLabel.textContent = '측정 전';
                dustLabel.textContent = '측정 전';
                gyroLabel.textContent = '측정 전';
                heartLabel.textContent = '측정 전';
                soilLabel.textContent = '측정 전';
                rainLabel.textContent = '측정 전';
                
                // 카메라 이미지 초기화
                cameraView.src = '';
            }
        });

        // NeoPixel 객체 인스턴스 생성
        const neopixel = new NeoPixel();

        // 밝기 설정 버튼에 이벤트 리스너 추가
        document.getElementById('neopixelBrightnessBtn').addEventListener('click', async () => {
            // 입력된 밝기 값 가져오기 (0-100)
            const brightnessValue = parseInt(document.getElementById('brightness').value);
            
            // 유효성 검사
            if (isNaN(brightnessValue) || brightnessValue < 0 || brightnessValue > 255) {
                console.error('밝기는 0-255 사이의 값이어야 합니다.');
                return;
            }
            
            try {
                // 네오픽셀 밝기 설정
                await neopixel.setBrightness(brightnessValue);
                console.log(`네오픽셀 밝기가 ${brightnessValue}%로 설정되었습니다.`);
            } catch (error) {
                console.error('네오픽셀 밝기 설정 중 오류 발생:', error);
            }
        });

        

        // 시리얼 연결 버튼 이벤트 리스너
        serialConnectBtn.addEventListener('click', async () => {
            if (serialManager.isConnected) {
                // 이미 연결된 경우 연결 해제
                await serialManager.disconnect();
                serialConnectBtn.textContent = '시리얼 연결';
                serialStatus.textContent = '시리얼 연결 상태: 연결되지 않음';
                serialStatus.style.color = 'gray';
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: 시리얼 연결이 종료되었습니다.\n';
                return;
            }

            try {
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: 시리얼 포트 연결 시도 중...\n';
                
                // 시리얼 연결 시도
                await serialManager.connect();
                
                // UI 업데이트
                serialConnectBtn.textContent = '연결 해제';
                serialStatus.textContent = '시리얼 연결 상태: 연결됨 (보드 리셋 필요)';
                serialStatus.style.color = 'green';
                
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: ESP32-S3 시리얼 연결 성공!\n';
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: ※ 중요: 보드의 리셋 버튼을 눌러주세요. BLE 이름은 부팅 시에만 출력됩니다.\n';
                
            } catch (error) {
                console.error('시리얼 연결 오류:', error);
                serialStatus.textContent = `시리얼 연결 오류: ${error.message}`;
                serialStatus.style.color = 'red';
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 오류: ' + error.message + '\n';
            }
        });

        // 시리얼 데이터 수신 콜백 등록
        serialManager.onData(({ text }) => {
            if (!serialOutput) return;
            
            // 시리얼 출력 영역에 메시지 추가
            serialOutput.value += text;
            
            // 스크롤을 항상 아래로 유지
            serialOutput.scrollTop = serialOutput.scrollHeight;
        });
        
        // BLE 이름 추출 콜백 등록
        serialManager.onBleNameExtracted((bleName) => {
            const bleNameInput = document.getElementById('bleNameInput');
            if (bleNameInput) {
                bleNameInput.value = bleName;
                serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: BLE 이름이 자동으로 설정되었습니다: ' + bleName + '\n';
                
                // BLE 이름을 찾은 후 자동으로 연결 해제
                setTimeout(() => {
                    if (serialManager.isConnected) {
                        serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: BLE 이름을 성공적으로 추출했습니다. 시리얼 연결을 종료합니다.\n';
                        serialManager.disconnect();
                        serialConnectBtn.textContent = 'BLE 이름 추출';
                        serialStatus.textContent = 'BLE 이름 추출 완료';
                        serialStatus.style.color = 'green';
                    }
                }, 1000);
            }
        });
        
        // 연결/해제 콜백 등록
        serialManager.onConnect(() => {
            console.log('시리얼 연결 성공');
        });
        
        serialManager.onDisconnect(() => {
            // 연결이 끊어진 상태 업데이트
            if (serialConnectBtn) {
                serialConnectBtn.textContent = 'BLE 이름 추출';
            }
            
            if (serialStatus) {
                serialStatus.textContent = '시리얼 연결 상태: 연결 끊어짐';
                serialStatus.style.color = 'red';
            }
            
            serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 시스템: 시리얼 연결이 끊어졌습니다.\n';
        });
        
        // 에러 콜백 등록
        serialManager.onError(({ message }) => {
            serialOutput.value += '[' + new Date().toLocaleTimeString() + '] 오류: ' + message + '\n';
        });

        // 페이지 종료 시 시리얼 연결 정리
        window.addEventListener('unload', () => {
            if (serialManager.isConnected) {
                serialManager.disconnect();
            }
        });

    </script>
</body>
</html> 